### Jinliang Yang
### 9/24/2015

##############################################
library(wesanderson)
library(ggplot2)
source("~/Documents/Github/zmSNPtools/Rcodes/multiplot.R")

plot_k_gerp <- function(dat,med2, out, outfile="largedata/lgraphs/gerp_k7x_others.pdf"){
    
    #cols <- wes_palette(7, name = "Zissou", type = "continuous")
    cols <- c("#008080", "#003366", "#40e0d0", "#ffa500", "#f6546a", "#ff00ff", "#800000")
    theme_set(theme_grey(base_size = 18)) 
    
    lty1 <- getlty(df=out, eff="effa", cutoff=0.05)$l
    p1 <- ggplot(dat, aes(x=RS, y=Effect_A, colour=factor(trait, levels=med2$trait),
                          linetype=factor(trait, levels=med2$trait))) +
        labs(colour="Traits") +
        theme_bw() +
        xlab("GERP Score") +
        ylab("Additive Effect") +
        #  (by default includes 95% confidence region)
        #scale_fill_manual(values=c("#008080", "#003366", "#40e0d0", "#ffa500", "#f6546a", "#ff00ff", "#800000")) +
        #http://www.sthda.com/english/wiki/ggplot2-colors-how-to-change-colors-automatically-and-manually
        scale_color_manual(values=cols) +
        scale_linetype_manual(values=lty1) +
        guides(colour=FALSE, linetype=FALSE) +
        
        geom_smooth(method="gam") +
        theme(axis.text.y = element_text(angle = 90, hjust = 1))
    
    
    lty2 <- getlty(df=out, eff="effd", cutoff=0.05)$l
    p2 <- ggplot(dat, aes(x=RS, y=Effect_D, colour=factor(trait, levels=med2$trait),
                          linetype=factor(trait, levels=med2$trait))) +
        labs(colour="Traits") +
        theme_bw() +
        xlab("GERP Score") +
        ylab("Dominant Effect") +
        scale_color_manual(values=cols) +
        scale_linetype_manual(values=lty2) +
        guides(colour=FALSE, linetype=FALSE) +
        
        theme(axis.text.y = element_text(angle = 90, hjust = 1)) +
        geom_smooth(method="gam")   # Add linear regression line 
    
    lty3 <- getlty(df=out, eff="effk", cutoff=0.05)$l
    p3 <- ggplot(dat, aes(x=RS, y=k, colour=factor(trait, levels=med2$trait),
                          linetype=factor(trait, levels=med2$trait))) +
        #geom_point(shape=1) +    # Use hollow circles
        labs(colour="Traits") +
        theme_bw() +
        xlab("GERP Score") +
        ylab("Degree of Domiance (k)") +
        scale_color_manual(values=cols) +
        scale_linetype_manual(values=lty3) +
        guides(colour=FALSE, linetype=FALSE) +
        
        theme(axis.text.y = element_text(angle = 90, hjust = 1)) +
        geom_smooth(method="gam")   # Add linear regression line 
    
    lty4 <- getlty(df=out, eff="h2a", cutoff=0.05)$l
    p4 <- ggplot(dat, aes(x=RS, y=h2_mrk_A, colour=factor(trait, levels=med2$trait),
                          linetype=factor(trait, levels=med2$trait))) +
        #geom_point(shape=1) +    # Use hollow circles
        labs(colour="Traits") +
        theme_bw() +
        xlab("GERP Score") +
        ylab("Additive Variance") +
        scale_color_manual(values=cols) +
        scale_linetype_manual(values=lty4) +
        guides(colour=FALSE, linetype=FALSE) +
        
        theme(axis.text.y = element_text(angle = 90, hjust = 1)) +
        geom_smooth(method="gam") 
    
    lty5 <- getlty(df=out, eff="h2d", cutoff=0.05)$l
    p5 <- ggplot(dat, aes(x=RS, y=h2_mrk_D, colour=factor(trait, levels=med2$trait),
                          linetype=factor(trait, levels=med2$trait))) +
        #geom_point(shape=1) +    # Use hollow circles
        labs(colour="Traits") +
        theme_bw() +
        xlab("GERP Score") +
        ylab("Dominant Variance") +
        scale_color_manual(values=cols) +
        scale_linetype_manual(values=lty5) +
        guides(colour=FALSE, linetype=FALSE) +
        
        theme(axis.text.y = element_text(angle = 90, hjust = 1)) +
        geom_smooth(method="gam") 
    
    lty6 <- getlty(df=out, eff="h2k", cutoff=0.05)$l
    p6 <- ggplot(dat, aes(x=RS, y=H2_mrk, colour=factor(trait, levels=med2$trait),
                          linetype=factor(trait, levels=med2$trait))) +
        #geom_point(shape=1) +    # Use hollow circles
        labs(colour="Traits") +
        theme_bw() +
        xlab("GERP Score") +
        ylab("Total Variance") +
        scale_color_manual(values=cols) +
        scale_linetype_manual(values=lty6) +
        guides(colour=FALSE, linetype=FALSE) +
        
        theme(axis.text.y = element_text(angle = 90, hjust = 1)) +
        geom_smooth(method="gam") 
    
    #multiplot(p1, p4, p2, p5, p3, p6, cols=3)
    pdf(outfile, width=13, height=8)
    multiplot(p1, p4, p2, p5, p3, p6, cols=3)
    dev.off()
}

getlty <- function(df, eff, cutoff=0.05){
    df$l <- 2
    if(nrow(df[df[, eff] < cutoff, ]) >0) df[df[, eff] < cutoff, ]$l <- 1
    return(df)
}



##########################################################
#####
geno <- fread("largedata/gerpsnp_v3_410183.csv", data.table=FALSE)
geno <- geno[, 1:4]


toremove=TRUE
for(i in 0){
    kval <- fread(paste0("largedata/lcache/noB73_kval_perse_", i, "x.csv"), data.table=FALSE)
    dat <- merge(kval, geno, by.x="snpid", by.y="marker")
    #dat$Effect_A <- dat$Effect_A + mean(dat$Effect_A)
    
    #dat <- subset(dat, Effect_A > 0)
    
    dat$Effect_A <- as.numeric(as.character(dat$Effect_A))
    dat$Effect_D <- as.numeric(as.character(dat$Effect_D))
    #dat$k <- -dat$Effect_D/abs(dat$Effect_A)
    #dat$Effect_D <- -dat$Effect_D
    #dat$Effect_A <- abs(dat$Effect_A)
    #dat$Effect_D <- abs(dat$Effect_D)
    #dat$k <- dat$Effect_D/abs(dat$Effect_A)
    dat$k <- dat$Effect_D/abs(dat$Effect_A)
    
    dat$trait <- toupper(dat$trait)
    dat[dat$trait %in% c("GY", "PHT", "EHT"),]$Effect_A <- dat[dat$trait %in% c("GY", "PHT", "EHT"),]$Effect_A + 0.02
    #dat <- subset(dat, trait %in% tolower(c("ASI", "DTP", "DTS", "EHT", "GY", "PHT", "TW")))
    
    if(toremove){
        if(sum(dat$k > 1) > 0){
            if(sum(dat$k > 2) > 0){
                dat[dat$k > 2, ]$k <- 2
            }
            #out[out$k > 1, ]$k <- rescale(out[out$k > 1, ]$k, c(1, 2))
        }
        if(sum(dat$k < -1) > 0){
            if(sum(dat$k < -2) > 0){
                dat[dat$k < -2, ]$k <- -2
            }
            #out[out$k < -1, ]$k <- rescale(out[out$k < -1, ]$k, c(-2, -1))
        }
    }else{
        dat <- subset(dat, abs(k) < 2)
    }
    
    med2 <- data.frame(trait=c("ASI", "DTP", "DTS", "EHT", "GY", "PHT", "TW"), 
                       phph=c(-0.24725, -0.08345, -0.10605,  0.29005,  1.24175,  0.25460, -0.00955) )
    med2 <- med2[order(med2$phph), ]
    
    out <- data.frame()
    med2$trait <- as.character(med2$trait)
    for(j in 1:7){
        sub <- subset(dat, trait == med2$trait[j])
        fit1 <- lm(sub$Effect_A ~ sub$RS)
        t1 <- cor.test(sub$Effect_A, sub$RS)
        t2 <- cor.test(sub$Effect_D, sub$RS)
        t3 <- cor.test(sub$k, sub$RS)
        t4 <- cor.test(sub$h2_mrk_A, sub$RS)
        t5 <- cor.test(sub$h2_mrk_D, sub$RS)
        t6 <- cor.test(sub$H2_mrk, sub$RS)
        
        tem <- data.frame(trait=med2$trait[j], effa=t1$p.value, effar=t1$estimate,
                          effd=t2$p.value, effdr=t2$estimate,
                          effk=t3$p.value, effkr=t3$estimate,
                          h2a=t4$p.value, h2ar=t4$estimate,
                          h2d=t5$p.value, h2dr=t5$estimate,
                          h2k=t6$p.value, h2kr=t6$estimate)
        #tem <- data.frame(trait=med2$trait[j], a=coef(fit1)["(Intercept)"], beta=coef(fit1)["sub$RS"])
        out <- rbind(out, tem)
    }
    print(i)
    print(out)
    #### start to plot:
    #plot_k_gerp(dat, med2, out, outfile=paste0("largedata/lgraphs/gerp_k", i, "x_tem.pdf"))
    
}
i=0
dat <- subset(dat, !(trait %in% "SAMPLE") )
plot_k_gerp(dat, med2, out, outfile=paste0("largedata/lgraphs/gerp_k", i, "x_tem.pdf"))


write.table(dat, "largedata/gerpdat0x_noB73.csv", sep=",", row.names=FALSE, quote=FALSE)
write.table(out, "cache/eff_adk_0x_noB73.csv", sep=",", row.names=FALSE, quote=FALSE)
#write.table(out, "cache/s_estimation.csv", sep=",", row.names=FALSE, quote=FALSE)





